import React, { useEffect, useState } from 'react';
import api from '../api';

export default function Pentest() {
  const [settings, setSettings] = useState({ mode: 'SAFE' });
  const [attack, setAttack] = useState({ mode: 'deauth', target: '', channel: 1 });

  useEffect(() => {
    api.get('/api/settings').then(res => setSettings(res.data));
  }, []);

  const updateMode = async (mode) => {
    const res = await api.post('/api/settings', { mode });
    setSettings(res.data);
  };

  const startAttack = async () => {
    try {
      await api.post('/api/nic/attack', attack);
      alert('Attack triggered');
    } catch (err) {
      alert('Attack failed: ' + err.response?.data?.detail || err.message);
    }
  };

  const sendCommand = (opcode, payload = {}) => {
    api.post('/api/command', { opcode, payload });
  };

  return (
    <div style={{ padding: '1rem' }}>
      <h2>Pentest Controls</h2>

      <div style={{ marginBottom: '1rem' }}>
        <span>Mode: {settings.mode}</span>
        <button
          onClick={() => {
            if (settings.mode === 'SAFE') {
              if (window.confirm('Enable AGGRESSIVE mode? For authorized testing only.')) {
                updateMode('AGGRESSIVE');
              }
            } else {
              updateMode('SAFE');
            }
          }}
          style={{ marginLeft: '1rem' }}>
          Toggle Mode
        </button>
      </div>

      <div style={{ display: 'flex', gap: '1rem', marginBottom: '1rem' }}>
        <button onClick={() => sendCommand(0x01, { scan: true })}>Start Scan</button>
        <button onClick={() => sendCommand(0x02)}>Start Captive Portal</button>
        <button onClick={() => sendCommand(0x20)}>Reboot Node</button>
      </div>

      <div style={{ border: '1px solid #ccc', padding: '1rem', width: '300px' }}>
        <h3>TL-WN722N Attack</h3>
        <label>
          Mode
          <select value={attack.mode} onChange={e => setAttack({ ...attack, mode: e.target.value })}>
            <option value="deauth">Deauth</option>
            <option value="rogue_ap">Rogue AP</option>
            <option value="pmkid">PMKID</option>
            <option value="swarm">Swarm</option>
            <option value="survey">Survey</option>
            <option value="jam">Jam</option>
          </select>
        </label>
        <input
          type="text"
          placeholder="Target MAC"
          value={attack.target}
          onChange={e => setAttack({ ...attack, target: e.target.value })}
          style={{ width: '100%', marginTop: '0.5rem' }}
        />
        <input
          type="number"
          placeholder="Channel"
          value={attack.channel}
          onChange={e => setAttack({ ...attack, channel: parseInt(e.target.value) })}
          style={{ width: '100%', marginTop: '0.5rem' }}
        />
        <button onClick={startAttack} style={{ marginTop: '0.5rem' }}>
          Launch Attack
        </button>
      </div>
    </div>
  );
}

